@page "/scrap"
@page "/scrap/{start}"
@page "/scrap/{start}/{end}"
@using System.IO;
@using System.ComponentModel;
@using System.Runtime.CompilerServices;
@using RE=System.Text.RegularExpressions;
@using Volo.Abp.AspNetCore.Components.Notifications;
@using We.Results;
@using We.Processes;
@using We.Turf.Queries;
@using We.Utilities;
@using We.Blazor.Csv
@using We.Turf.Entities;
@inject IPmuScrapAppService Scrapper;
@inject IPmuServiceAppService AppService;
@inject IReactiveOutputExecutor Output;
@inject IUiNotificationService? UiNotificationService;
@implements INotifyPropertyChanged
<div class="mb-3">
    <Fields>
        <Field ColumnSize="ColumnSize.Is1.OnDesktop">
            <Check TValue="bool" @bind-Checked="@scrap">Scrap</Check>
        </Field>
        <Field ColumnSize="ColumnSize.Is1.OnDesktop">
            <Check TValue="bool" @bind-Checked="@predict">Predict</Check>
        </Field>
        <Field ColumnSize="ColumnSize.Is1.OnDesktop">
            <Check TValue="bool" @bind-Checked="@resultat">Resulat</Check>
        </Field>
        <Field ColumnSize="ColumnSize.Is1.OnDesktop">
            <Check TValue="bool" @bind-Checked="@scrapByFolderMonth">Par Dossier</Check>
        </Field>
    </Fields>
</div>
<div class="mb-3">
    <Fields>
        @if (!scrapByFolderMonth)
        {
            <Field ColumnSize="ColumnSize.Is3.OnDesktop" Visibility="@HideIfLoadFromFolder">
                <FieldLabel>Date Start</FieldLabel>
                <TextEdit Placeholder="Entrer date de debut" @bind-Text="@InnerStart" />
            </Field>
            <Field ColumnSize="ColumnSize.Is3.OnDesktop" Visibility="@HideIfLoadFromFolder">
                <FieldLabel>Date End</FieldLabel>
            <TextEdit Placeholder="Entrer date de fin" @bind-Text="@InnerEnd" />
        </Field>
        }else{
        <Field ColumnSize="ColumnSize.Is3.OnDesktop" Visibility="@HideIfLoadFromDate">
            <FieldLabel>Dossier de chargement (MM YYYY)</FieldLabel>
            <TextEdit Placeholder="Dossier " @bind-Text="@InnerFolder" />
        </Field>
        }
    </Fields>
</div>
<div class="mb-3">

    <Button Color="Color.Primary" Clicked="Extract" Loading="@isExtractRunning" Disabled="@isExtractRunning" Visibility="@ExtractDatasVisibility">Extraction et Prediction</Button>
    <Button Color="Color.Secondary" Clicked="InsertDatas" Loading="@isInsertDatasRunning" Disabled="@isInsertDatasRunning" Visibility="@InsertDatasVisibility">Inserer dans la Base de données</Button>
</div>

<div class="mb-3">
    <Tabs SelectedTab="@selectedTab" SelectedTabChanged="@OnSelectedTabChanged">
        <Items>
            <Tab Name="output">Sortie</Tab>
            <Tab Name="to_predict">A Prédire</Tab>
            <Tab Name="predicted">Prediction</Tab>
            <Tab Name="courses">Courses</Tab>
            <Tab Name="resultats">Arrivées</Tab>
        </Items>
        <Content>
            <TabPanel Name="output">
                <Fields>
                    <Field ColumnSize="ColumnSize.Is6.OnDesktop">
                        <label for="console" class="form-label">Console</label>
                        <textarea class="form-control" id="console" rows="30" @bind="ConsoleOutput"></textarea>
                    </Field>
                </Fields>
            </TabPanel>

            <ScrapTabPanelFile Name="to_predict" Files="ToPredictFiles" Type="PmuFileType.ToPredict" CsvHasHeader="false" />
            <ScrapTabPanelFile Name="predicted" Files="PredictedFiles" Type="PmuFileType.Predicted" CsvHasHeader="false" />
            <ScrapTabPanelFile Name="courses" Files="CoursesFiles" Type="PmuFileType.Course" CsvHasHeader="false" />
            <ScrapTabPanelFile Name="resultats" Files="ResultatsFiles" Type="PmuFileType.Resultat" CsvHasHeader="false" />


        </Content>
    </Tabs>
</div>

@code {
    bool scrap, predict, resultat, scrapByFolderMonth;
    string _innerFolder = string.Empty;
    [Parameter]
    public string Start { get; set; } = string.Empty;

    [Parameter]
    public string End { get; set; } = string.Empty;

    public ParameterDto? Parameter { get; set; } = null;
    public string InnerStart { get; set; } = string.Empty;
    public string InnerEnd { get; set; } = string.Empty;
    public string InnerFolder
    {
        get => _innerFolder;
        set
        {
            _innerFolder = value;
            NotifyPropertyChanged();
        }
    }

    bool isExtractRunning = false;
    bool isInsertDatasRunning = false;
    bool CanInsertdatas => ToPredictFiles.Any() && PredictedFiles.Any() && CoursesFiles.Any() && ResultatsFiles.Any();
    Visibility InsertDatasVisibility => CanInsertdatas ? Visibility.Visible : Visibility.Invisible;
    Visibility ExtractDatasVisibility => isInsertDatasRunning ? Visibility.Invisible : Visibility.Visible;
    Visibility HideIfLoadFromFolder => scrapByFolderMonth ? Visibility.Invisible : Visibility.Visible;
    Visibility HideIfLoadFromDate => !scrapByFolderMonth ? Visibility.Invisible : Visibility.Visible;



    List<FileWithContent> files = new();
    List<string> ColumnNames = new List<string>() { "date", "reunion", "course", "nom", "numPmu" };
    public string ConsoleOutput { get; set; } = string.Empty;
    IEnumerable<FileWithContent> ToPredictFiles => files.Where(x => x.Type == PmuFileType.ToPredict);
    IEnumerable<FileWithContent> PredictedFiles => files.Where(x => x.Type == PmuFileType.Predicted);
    IEnumerable<FileWithContent> CoursesFiles => files.Where(x => x.Type == PmuFileType.Course);
    IEnumerable<FileWithContent> ResultatsFiles => files.Where(x => x.Type == PmuFileType.Resultat);

    public event PropertyChangedEventHandler? PropertyChanged = null;

    protected override async Task OnInitializedAsync()
    {
        if(!string.IsNullOrEmpty(Start))
            scrapByFolderMonth = IsValidMonthYear(Start);


        var res = await Scrapper.GetParameter(new());
        if (res)
        {
            Parameter = res.Value.Parameter;

        }

        ConsoleOutput = string.Empty;
        Output.OnOutput.Subscribe(x => ConsoleOutput = $"{ConsoleOutput}\n{x}");

        if (scrapByFolderMonth)
        {

            var ss = Start.Split(' ');
            var dd = new DateOnly(int.Parse(ss[1]), int.Parse(ss[0]), 1);
            InnerStart = dd.ToString("ddMMyyyy");
            InnerEnd = dd.AddMonths(1).AddDays(-1).ToString("ddMMyyyy");
            InnerFolder = Start;
        }
        else
        {
            var dates = await ParseDate(Start, End);
            InnerStart = dates.Item1.ToString("ddMMyyyy");
            InnerEnd = dates.Item2.ToString("ddMMyyyy");
        }

        this.WhenPropertyChanged()
      .Where(e => e.EventArgs.PropertyName == nameof(InnerFolder))
      .Select(e => _innerFolder)
      .Subscribe(async folder => await UpdateFiles());

        await UpdateFiles();
    }


    /*string BaseInnerFolder
    {
    get
    {
    if (Parameter is null)
    return string.Empty;
    if (!string.IsNullOrEmpty(InnerFolder) && setInFolder)
    return $"{Parameter.BaseScrapFolder}{Path.DirectorySeparatorChar}{InnerFolder}";
    if (!setInFolder)
    return Parameter?.BaseScrapFolder ?? string.Empty;
    return string.Empty;
    }
    }*/

    string InputFolder
    {
        get
        {
            if (Parameter is null)
                return string.Empty;
            if (!string.IsNullOrEmpty(InnerFolder) && scrapByFolderMonth)
                return $"{Parameter.InputScrapFolder}{Path.DirectorySeparatorChar}{InnerFolder}";
            if (!scrapByFolderMonth)
                return Parameter?.InputScrapFolder ?? string.Empty;
            return string.Empty;
        }
    }
    string OutputFolder
    {
        get
        {
            if (Parameter is null)
                return string.Empty;
            if (!string.IsNullOrEmpty(InnerFolder) && scrapByFolderMonth)
                return $"{Parameter.OutputScrapFolder}{Path.DirectorySeparatorChar}{InnerFolder}";
            if (!scrapByFolderMonth)
                return Parameter?.OutputScrapFolder ?? string.Empty;
            return string.Empty;
        }
    }
    string ToPredictFilePath => Parameter is not null ? @$"{Parameter.BaseScrapFolder}{Path.DirectorySeparatorChar}{InputFolder}" : string.Empty;
    string PredictedFilename => Parameter is not null ? @$"{Parameter.BaseScrapFolder}{Path.DirectorySeparatorChar}{OutputFolder}{Path.DirectorySeparatorChar}{Parameter.PredictionFilename}" : string.Empty;
    string CourseFilename => Parameter is not null ? @$"{Parameter.BaseScrapFolder}{Path.DirectorySeparatorChar}{OutputFolder}{Path.DirectorySeparatorChar}{Parameter.CourseFilename}" : string.Empty;
    string OutputFilePath => Parameter is not null ? @$"{Parameter.BaseScrapFolder}{Path.DirectorySeparatorChar}{OutputFolder}" : string.Empty;

    async Task UpdateFiles()
    {

        files = new();
        if (!Directory.Exists(ToPredictFilePath))
            UiNotificationService?.Warn($"ToPredictFilePath {ToPredictFilePath} n'existe pas");
        else
        {
            //var res0 = await Scrapper.BrowseToPredictFiles(new() { Path = @"e:\projets\pmu_scrapper\input" });
            var res0 = await Scrapper.BrowseToPredictFiles(new() { Path = ToPredictFilePath });
            if (res0)
                files.AddRange(res0.Value.Files.Select(x => new FileWithContent() { Path = x, Type = PmuFileType.ToPredict }));
        }

        if (!File.Exists(PredictedFilename))
            UiNotificationService?.Warn($"PredictedFilename {PredictedFilename} n'existe pas");
        else
        {
            //var res1 = await Scrapper.BrowsePredictedFiles(new() { Filename = @"e:\projets\pmu_scrapper\output\predicted.csv" });
            var res1 = await Scrapper.BrowsePredictedFiles(new() { Filename = PredictedFilename });
            if (res1)
                files.Add(new FileWithContent() { Path = res1.Value.File, Type = PmuFileType.Predicted });


        }

        if (!File.Exists(CourseFilename))
            UiNotificationService?.Warn($"CourseFilename {CourseFilename} n'existe pas");
        else
        {
            //var res2 = await Scrapper.BrowseCourseFiles(new() { Filename = @"e:\projets\pmu_scrapper\output\courses.csv" });
            var res2 = await Scrapper.BrowseCourseFiles(new() { Filename = CourseFilename });
            if (res2)
                files.Add(new FileWithContent() { Path = res2.Value.File, Type = PmuFileType.Course });
        }

        if (!Directory.Exists(OutputFilePath))
            UiNotificationService?.Warn($"OutputFilePath {OutputFilePath} n'existe pas");
        else
        {
            //var res3 = await Scrapper.BrowseResultatsFiles(new() { Path = @"e:\projets\pmu_scrapper\output" });
            var res3 = await Scrapper.BrowseResultatsFiles(new() { Path = OutputFilePath });
            if (res3)
                files.AddRange(res3.Value.Files.Select(x => new FileWithContent() { Path = x, Type = PmuFileType.Resultat }));

        }
    }

    private async Task<(DateOnly, DateOnly)> ParseDate(string startDate, string endDate)
    {
        var res_start = startDate.TryParseToDateOnly(out var _date_start);
        var res_end = endDate.TryParseToDateOnly(out var _date_end);

        if (!res_start)
        {
            var ldate_result = await Scrapper.GetLastScrapped(new());
            if (ldate_result)
                _date_start = DateOnly.FromDateTime(ldate_result.Value.LastScrapped.LastDate).AddDays(1);
            else
                _date_start = DateOnlyExtensions.Now;
        }
        if (!res_end)
        {
            if (!Int32.TryParse(endDate, out int _count))
                _count = 1;
            _date_end = _date_start.AddDays(_count);
        }


        if (_date_start > _date_end)
        {
            var tmp = _date_start;
            _date_start = _date_end;
            _date_end = tmp;
        }
        return (_date_start, _date_end);
    }
    public async Task Extract()
    {
        isExtractRunning = true;
        ConsoleOutput = string.Empty;
        var dates = await ParseDate(InnerStart, InnerEnd);
        Output.WriteLine("Démarrage");
        if (scrap)
        {

            Output.WriteLine($"Scrap Start:{dates.Item1.ToShortDateString()} to Scrap End:{dates.Item2.ToShortDateString()}\nLaunched ...");

            var result0 = await Scrapper.Scrap(
                new ScrapQuery()
                    {
                        Start = dates.Item1,
                        End = dates.Item2,
                        DeleteFilesIfExists = true,
                        UseFolder = scrapByFolderMonth ? InnerFolder : string.Empty,
                    });

            if (!result0)
                Output.WriteLine(result0.Errors);
        }

        if (predict)
        {
            Output.WriteLine("Prediction");
            var result0 = await Scrapper.Predict(new PredictQuery() { UseFolder = scrapByFolderMonth ? InnerFolder:string.Empty, DeleteFilesIfExists = !scrapByFolderMonth });
            if (!result0)
                Output.WriteLine(result0.Errors);
        }

        if (resultat)
        {
            Output.WriteLine("Resultats");
            var result0 = await Scrapper.Resultats(new ResultatQuery()
                {
                    Start = dates.Item1,
                    End = dates.Item2,
                    UseFolder = scrapByFolderMonth ? InnerFolder : string.Empty,
                    DeleteFilesIfExists = !scrapByFolderMonth
                });
            if (!result0)
                Output.WriteLine(result0.Errors);
        }

        Output.WriteLine("Fini..");

        await UpdateFiles();

        isExtractRunning = false;
    }

    public async Task InsertDatas()
    {
        ConsoleOutput = string.Empty;
        isInsertDatasRunning = true;

        if(scrap && predict && resultat )
        {
            var res = await AppService.LoadOutputFolderIntoDb(new LoadOutputFolderIntoDbQuery() { Folder = OutputFilePath });
            if (res.HasError)
                 UiNotificationService?.Warn(res.Errors.AsString(),"Attention");
            else
                 UiNotificationService?.Success("Tout c'est bien passé!!","Confirmation");
        }
        else
        if (scrap)
        {
            Output.Write("Insertion des chevaux a predire");
            //foreach (var f in ToPredictFiles)
            //{
            var f = ToPredictFiles.First();
            var result = await AppService.LoadToPredictIntoDatabase(new LoadToPredictIntoDbQuery() { Filename = f.Path, Rename = false });

            foreach (var error in result.Errors)
            {

                Output.WriteLine($"[ERROR] {error.Failure} ");
            }

            //}
        }
        isInsertDatasRunning = false;

    }

    private async Task RefreshFileContent(PmuFileType type)
    {
        foreach (var f in files.Where(x => x.Type == type))
            await RefreshFileContent(f);
    }
    private async Task RefreshFileContent(FileWithContent file)
    {
        //if (file is null)
        await file.RefreshFileContent();
    }

    string selectedTab = "output";

    private Task OnSelectedTabChanged(string name)
    {
        selectedTab = name;

        return Task.CompletedTask;
    }

    protected void NotifyPropertyChanged([CallerMemberName] string propertyName = "")
    {
        PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
    }

    public static bool IsValidMonthYear(string input)
    {
        RE.Regex regex = new RE.Regex(@"^\d{2}\s+\d{4}$");
        RE.Match match = regex.Match(input);

        return match.Success;
    }
}
